from fastapi import FastAPI, HTTPException
from fastapi.responses import FileResponse
from fastapi.middleware.cors import CORSMiddleware

from models import ConvertRequest
from Services.figma_service import get_figma_file
from Services.layout_parser import parse_figma_layout
from Services.ai_services import generate_code
from storedb import (
    save_figma_json,
    update_parsed_layout,
    get_cached_figma
)

import os
import zipfile
import shutil

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
def root():
    return {"message": "Kriti backend running"}

@app.post("/convert")
def convert_design(req: ConvertRequest):
    try:
        figma_url = str(req.figma_url)
        framework = req.framework

        cached = get_cached_figma(figma_url, framework)

        # 1️⃣ Get figma JSON (NO re-fetch if cached)
        if cached and cached.get("figma_json"):
            figma_json = cached["figma_json"]
            print("[CACHE] Using stored Figma JSON")
        else:
            print("[FIGMA API] Fetching fresh JSON")
            figma_json = get_figma_file(figma_url)
            save_figma_json(figma_url, figma_json, framework)

        # 2️⃣ ALWAYS re-parse layout
        layout = parse_figma_layout(figma_json)
        update_parsed_layout(figma_url, framework, layout)

        # 3️⃣ Generate site
        out_dir = "generated_site"
        if os.path.exists(out_dir):
            shutil.rmtree(out_dir)
        os.makedirs(out_dir)

        pages = layout.get("pages", [])
        if not pages:
            raise Exception("No pages found in layout")

        for page in pages:
            for screen in page["screens"]:
                screen_name = screen["screen"].lower().replace(" ", "_")
                filename = f"{screen_name}.html"

                screen_layout = {
                    "page": page["page"],
                    "screen": screen["screen"],
                    "box": screen["box"],
                    "tree": screen["tree"]
                }

                code = generate_code(screen_layout, framework)
                if not code:
                    raise Exception(f"AI returned empty for {screen_name}")

                with open(os.path.join(out_dir, filename), "w", encoding="utf-8") as f:
                    f.write(code)

                print(f"[OK] Generated {filename}")

        # 4️⃣ Zip
        zip_path = "figma_site.zip"
        if os.path.exists(zip_path):
            os.remove(zip_path)

        with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
            for file in os.listdir(out_dir):
                zipf.write(os.path.join(out_dir, file), arcname=file)

        return {"downloadUrl": "http://127.0.0.1:8000/download"}

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/download")
def download_zip():
    return FileResponse(
        "figma_site.zip",
        media_type="application/zip",
        filename="figma_site.zip"
    )
"""
YOU MUST OUTPUT ONLY RAW HTML.
DO NOT WRITE MARKDOWN.
DO NOT WRITE PYTHON.
DO NOT WRITE EXPLANATIONS.
DO NOT USE CODE FENCES.

You are a senior frontend engineer building a production website from a Figma scene graph.

Your job is to reconstruct the same UI but improve it for real-world web usage.

RULES:

1. Preserve structure and hierarchy exactly.
2. Preserve visual intent (layout, spacing, grouping, typography).
3. Replace absolute positioning with natural document flow whenever possible.
4. Only use absolute positioning for small decorative or overlay elements.
5. Convert inline styles into Tailwind utility classes.
6. Use responsive classes (w-full, max-w-7xl, mx-auto, px-6, grid, flex).
7. Use semantic tags: header, nav, main, section, footer, article, button.
8. Optimize for desktop, tablet, and mobile.
9. Keep code clean and readable.

Preserve decorative and visual storytelling elements exactly.
Use absolute positioning only for decorative overlays such as:
- Step numbers
- Background shapes
- Floating badges

All functional layout should remain responsive.


IMAGE STRATEGY

If the design does not contain real image assets:

- Use high-quality relevant stock images instead of gray placeholders.
- Choose images that match the section context:
- Finance services → business / accounting imagery
- Onboarding steps → office, planning, documents, teamwork visuals
- Use real URLs from https://images.unsplash.com or https://source.unsplash.com
- Preserve aspect ratio and placement exactly as in Figma.
- Never use gray boxes or “Image” placeholders unless explicitly required.

OUTPUT:
ONE COMPLETE HTML DOCUMENT using Tailwind only.

INPUT:
{layout}
"""